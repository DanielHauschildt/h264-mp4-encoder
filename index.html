<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
</head>

<body>
  <script src="build_emscripten/h264_mp4_encoder.js"></script>
  <canvas width="800" height="600" style="border:1px solid black;"></canvas>
  <script>
    const canvas = document.getElementsByTagName("canvas")[0];
    const ctx = canvas.getContext("2d");
    const drawFrame = (interpolant) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#FF0000";
      ctx.fillRect(0, 0, canvas.width * interpolant, canvas.height * interpolant);
    };
    const download = (url, filename) => {
      const anchor = document.createElement("a");
      anchor.href = url;
      anchor.download = filename || "download";
      anchor.click();
    };

    H264MP4Module().then(async (hme) => {
      const encoder = new hme.H264MP4Encoder();
      encoder.onDataCallback = (data) => { };
      encoder.width = canvas.width;
      encoder.height = canvas.height;
      encoder.initialize();

      const frames = 100;
      for (let i = 0; i < frames; ++i) {
        drawFrame(i / frames);
        encoder.addFrameRgba(ctx.getImageData(0, 0, canvas.width, canvas.height).data);
        await new Promise(resolve => window.requestAnimationFrame(resolve));
      }

      encoder.finalize();
      const file = hme.FS.readFile("output.mp4");
      download(URL.createObjectURL(new Blob([file], { type: "video/mp4" })))
    })
  </script>
  <script>
  </script>
</body>

</html>